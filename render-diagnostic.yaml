services:
  - type: static_site
    name: gearted-web-app
    env: static
    plan: free
    autoDeploy: true
    branch: main
    headers:
      - path: "/*"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
    routes:
      - type: rewrite
        source: "/*"
        destination: "/index.html" 
    buildCommand: |
      echo "Starting diagnostic build..."
      
      # Create minimal test version first
      mkdir -p flutter-build
      cp test.html flutter-build/test.html
      
      # Try to build Flutter
      echo "Installing Flutter..."
      if command -v flutter >/dev/null 2>&1; then
          echo "Flutter already installed"
      else
          echo "Installing Flutter from scratch..."
          apt-get update && apt-get install -y --no-install-recommends git unzip xz-utils zip libglu1-mesa curl
          curl -L https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.22.2-stable.tar.xz -o flutter.tar.xz
          tar xf flutter.tar.xz
          export PATH="$PWD/flutter/bin:$PATH"
      fi
      
      # Show Flutter status
      flutter doctor || echo "Flutter doctor failed"
      
      # Try to build the app
      if [ -d "gearted-mobile" ]; then
          echo "Building Flutter app..."
          cd gearted-mobile
          flutter pub get || echo "pub get failed"
          flutter build web --release --web-renderer canvaskit || echo "Flutter build failed"
          
          if [ -d "build/web" ]; then
              echo "Moving Flutter build files..."
              cp -r build/web/* ../flutter-build/
          else
              echo "Flutter build directory not found, using test page"
              cd ..
              echo "<h1>Flutter build failed - Test mode active</h1>" > flutter-build/index.html
          fi
      else
          echo "gearted-mobile directory not found"
          echo "<h1>Source not found - Test mode active</h1>" > flutter-build/index.html
      fi
      
      echo "Build completed. Contents of flutter-build:"
      ls -la flutter-build/
    publishPath: flutter-build
