services:
  - type: static_site
    name: gearted-web-app
    env: flutter
    plan: free
    autoDeploy: true
    branch: main
    headers:
      - path: "/*"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
    routes:
      - type: rewrite
        source: "/*"
        destination: "/index.html" 
    buildCommand: |
      # Create publish directory first
      mkdir -p flutter-build
      
      # Install Flutter
      echo "Installing Flutter..."
      apt-get update && apt-get install -y --no-install-recommends git unzip xz-utils zip libglu1-mesa
      git clone https://github.com/flutter/flutter.git --depth 1 --branch 3.22.2 /opt/flutter
      export PATH="$PATH:/opt/flutter/bin"
      flutter doctor -v
      
      # Build Flutter app - Minimal HTML Version (Grey Screen Fix)
      echo "Building minimal HTML version to fix grey screen..."
      cd gearted-mobile
      
      # Clean environment completely
      echo "Cleaning environment..."
      flutter clean
      
      # Get dependencies 
      echo "Getting dependencies..."
      flutter pub get
      
      # Backup original files
      echo "Backing up original index.html..."
      cp web/index.html web/index.html.original
      
      # Use the ultra-minimal index.html that forces HTML renderer
      echo "Using ultra-minimal index.html with HTML renderer..."
      cp web/index_minimal.html web/index.html
      
      # Build with HTML renderer for maximum compatibility
      echo "Building with HTML renderer for guaranteed rendering..."
      flutter build web \
        --release \
        --web-renderer html \
        --pwa-strategy none
      
      # Force consistent viewport and no caching
      echo "Adding critical meta tags to HTML..."
      sed -i 's/<head>/<head>\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">/' build/web/index.html
      
      # Add fallback messaging
      echo "Adding fallback message for JavaScript-disabled browsers..."
      cat >> build/web/index.html << 'EOL'
<noscript>
  <div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;text-align:center;padding:20px;">
    <div>
      <h2>JavaScript est désactivé</h2>
      <p>L'application Gearted nécessite JavaScript pour fonctionner.</p>
      <p>Veuillez activer JavaScript dans votre navigateur et recharger la page.</p>
    </div>
  </div>
</noscript>
EOL
      
      # Move build output
      echo "Moving build files..."
      mv build/web/* ../flutter-build/
    publishPath: flutter-build