services:
  - type: static_site
    name: gearted-web-app
    env: flutter
    plan: free
    autoDeploy: true
    branch: main
    headers:
      - path: "/*"
        name: "Cache-Control"
        value: "no-cache, no-store, must-revalidate"
    routes:
      - type: rewrite
        source: "/*"
        destination: "/index.html" 
    buildCommand: |
      # Create publish directory first
      mkdir -p flutter-build
      
      # Install Flutter
      echo "Installing Flutter..."
      apt-get update && apt-get install -y --no-install-recommends git unzip xz-utils zip libglu1-mesa
      git clone https://github.com/flutter/flutter.git --depth 1 --branch 3.22.2 /opt/flutter
      export PATH="$PATH:/opt/flutter/bin"
      flutter doctor -v
      
      # Build Flutter app - Grey Screen Fix Special Edition
      echo "Building Flutter app with special grey screen fix..."
      cd gearted-mobile
      
      # Clean environment and get dependencies
      flutter clean
      flutter pub get
      
      # Backup original files
      cp web/index.html web/index.html.bak
      
      # Create a special version of index.html that uses the HTML renderer if CanvasKit fails
      echo "Applying grey screen fix to index.html..."
      cp web/index_new.html web/index.html
      
      # Add bootstrap.js script reference to index.html
      sed -i 's/<head>/<head>\n  <script src="bootstrap.js"><\/script>/' web/index.html
      
      # Create a production flutter web build with both renderers available
      echo "Building with dual-renderer configuration for maximum compatibility..."
      flutter build web \
        --release \
        --web-renderer canvaskit \
        --dart-define=FLUTTER_WEB_CANVASKIT_URL=/canvaskit/ \
        --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
        --pwa-strategy none \
        --csp
      
      # Ensure bootstrap.js is copied to the build directory
      cp web/bootstrap.js build/web/
      
      # Add special meta tags to index.html in build
      sed -i 's/<head>/<head>\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">\n  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">/' build/web/index.html
      
      # Add fallback content in case Flutter fails to load
      echo "Adding fallback content..."
      cat >> build/web/index.html << 'EOL'
<noscript>
  <div style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;text-align:center;padding:20px;">
    <div>
      <h2>JavaScript est désactivé</h2>
      <p>L'application Gearted nécessite JavaScript pour fonctionner.</p>
      <p>Veuillez activer JavaScript dans votre navigateur et recharger la page.</p>
    </div>
  </div>
</noscript>
EOL
      
      # Move build output
      echo "Moving build files..."
      mv build/web/* ../flutter-build/
    publishPath: flutter-build